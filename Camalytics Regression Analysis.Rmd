---
title: "Camalytics Regression Analysis"
author: "Cam Smithers"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Camalytics

## Overview

## Loading Packages & Exponential Variable

```{r}
library(dplyr)
library(ggplot2)
library(tidyverse)
library(foreign)
library(nnet)
library(readr)

e <- exp(1)
```

## Loading in All Data

```{r warning=FALSE}
#Running script that contains all data (teams and players)
source("/Users/camsmithers/Desktop/NBA Project/Main/Data/DataScript.R")

#Joining all team data into one data frame
all_team_data <- team_traditional %>%
    left_join(team_advanced, by = c("team", 'date')) %>% 
    left_join(team_misc, by = c("team", "date")) %>%
    left_join(team_scoring, by = c("team", "date")) %>%
    left_join(team_outcome, by = c("team", "date"))
```

## Data Cleaning 1: General Cleaning

```{r}
all_team_data <- all_team_data %>%
    dplyr::select(-opponent, -opponent.y, -opponent.x.x, -opponent.y.y, -home,
                  -home.y, -home.x.x,
           -home.y.y, -blk.y, -pf.y) %>% #Removing duplicated columns
    rename("opponent" = "opponent.x", "blk" = "blk.x", "pf" = "pf.x",
           "home" = "home.x") %>% #Wanted to keep specific duplicated to be used as the main
    dplyr::select(team, home, everything()) #Re-ordering variables for better visualization
team_temporary_df <- all_team_data %>% #Temporary data frame used add opponents' points scored
    dplyr::select(team, opponent, date,
                  #Traditional Statistics
                  pts, fgpct,
                  #Advanced Statistics
                  threefgpct, efgpct, tspct) %>%
    rename("team_1" = "team", "team_2" = "opponent",
           "opponent_pts" = "pts", "opponent_fgpct" = "fgpct",
           "opponent_threefgpct" = "threefgpct", "opponent_efgpct" = "efgpct",
           "opponent_tspct" = "tspct") %>%
    dplyr::select(-team_1)

all_team_data <- all_team_data %>% #Joining opponent points to original data frame
    left_join(team_temporary_df, by = c("team" = "team_2", "date"))

all_team_data <- all_team_data %>% #Re-ordering for better visualization
    dplyr::select(date, home, team, pts, opponent, opponent_pts, everything()) %>%
    rename_with(~ paste0("team_", .)) #Adding _team to each observation for easier recognition of variable for later cleaning, model building, and joins
```

## Data Cleaning 2: Creating Variables for Outcomes

1.  Primary Outcome: Game Outcome Type
2.  Changing Variable to Factor
3.  Creating Binary Variables for Primary Outcomes
4.  Secondary Outcome: Game Outcome without Magnitude

```{r}
all_team_data <- all_team_data %>%
    #Outcome 1 (Primary): Game Outcome (w/ Magnitude)
    mutate(team_game_outcome = case_when(
        team_plusminus > 0 & team_plusminus <= 10 ~ 1,
        team_plusminus < 0 & team_plusminus >= -10 ~ 2,
        team_plusminus > 10 ~ 3,
        team_plusminus < -10 ~ 4
    )) %>%
    #Outcome 2 (Primary): Game Outcome 
    mutate(team_game_outcome_2 = ifelse(team_plusminus > 0, 1, 0)) %>%
    #Outcome 3 (Secondary): Game Outcome Magnitude (w/ Primary Outcome Assumption)
    mutate(team_game_outcome_3 = case_when(
        team_plusminus > 10 ~ 1, 
        team_plusminus > 0 & team_plusminus <= 10 ~ 0,
        TRUE ~ NA
    )) %>%
    #Outcome 4 (Secondary): Game Outcome (w/ Previous Condition Met)
    mutate(team_game_outcome_4 = case_when(
        team_favored == 1 & team_plusminus < 0 ~ 1,
        team_favored == 1 & team_plusminus > 0 ~ 0,
        TRUE ~ NA
    )) %>%
    #Variables for Later Mutation
    mutate(team_win = ifelse(team_plusminus > 0, 1, 0),
           team_loss = ifelse(team_plusminus < 0, 1, 0))
    
```

## Data Cleaning 3: Team Averages

```{r}
all_team_average <- all_team_data %>%
    group_by(team_team) %>%
    mutate(
        #Offensive Statistics
        team_cummean_pts = round(cummean(team_pts), 1),
        team_cummean_offrating = round(cummean(team_offrating), 1),
        team_cummean_fgpct = round(cummean(team_fgpct), 1),
        team_cummean_efgpct = round(cummean(team_efgpct), 1),
        team_cummean_tspct = round(cummean(team_tspct), 1),
        
        #Defensive Statistics
        team_cummean_pts_allowed = round(cummean(team_opponent_pts), 1),
        team_cummean_defrating = round(cummean(team_defrating), 1),
        team_cummean_fgpct_allowed = round(cummean(team_opponent_fgpct), 1),
        team_cummean_efgpct_allowed = round(cummean(team_opponent_fgpct), 1),
        team_cummean_tspct_allowed = round(cummean(team_opponent_tspct), 1),
        
        #Other Statistics
        team_cummean_reb = round(cummean(team_reb), 1),
        team_cummean_tov = round(cummean(team_tov), 1),
        team_cummean_netrating = round(cummean(team_netrating), 1),
        
        #Situational Statistics
        #Win
        team_cummean_pts_win = case_when(
            team_plusminus > 0 ~ round(cummean(team_pts), 1),
            team_plusminus < 0 ~ NA),
        team_cummean_pts_allowed_win = case_when(
            team_plusminus > 0 ~ round(cummean(team_opponent_pts), 1),
            team_plusminus < 0 ~ NA),
        team_cummean_netrating_win = case_when(
            team_plusminus > 0 ~ round(cummean(team_netrating), 1),
            team_plusminus < 0 ~ NA),
        #Loss
        team_cummean_pts_loss = case_when(
            team_plusminus < 0 ~ round(cummean(team_pts), 1),
            team_plusminus > 0 ~ NA),
        team_cummean_pts_allowed_loss = case_when(
            team_plusminus < 0 ~ round(cummean(team_opponent_pts), 1),
            team_plusminus > 0 ~ NA),
        team_cummean_netrating_loss = case_when(
            team_plusminus < 0 ~ round(cummean(team_netrating), 1),
            team_plusminus > 0 ~ NA)
        ) %>%
    fill(
        #Offensive Statistics
        team_cummean_pts, team_cummean_offrating, team_cummean_fgpct,
        team_cummean_efgpct, team_cummean_tspct,
        #Defensive Statistics
        team_cummean_pts_allowed, team_cummean_defrating, team_cummean_fgpct_allowed,
        team_cummean_efgpct_allowed, team_cummean_tspct_allowed,
        #Other Statistics
        team_cummean_reb, team_cummean_tov, team_cummean_netrating,
        #Situational Statistics
        team_cummean_pts_win, team_cummean_pts_allowed_win, team_cummean_netrating_win, 
        team_cummean_pts_loss, team_cummean_pts_allowed_loss, team_cummean_netrating_loss,
        .direction = "down"
        ) %>%
    dplyr::select(
        team_team, team_date,
        #Offensive Statistics
        team_cummean_pts, team_cummean_offrating, team_cummean_fgpct,
        team_cummean_efgpct, team_cummean_tspct,
        #Defensive Statistics
        team_cummean_pts_allowed, team_cummean_defrating, team_cummean_fgpct_allowed,
        team_cummean_efgpct_allowed, team_cummean_tspct_allowed,
        #Other Statistics
        team_cummean_reb, team_cummean_tov, team_cummean_netrating,
        #Situational Statistics
        team_cummean_pts_win, team_cummean_pts_allowed_win, team_cummean_netrating_win, 
        team_cummean_pts_loss, team_cummean_pts_allowed_loss, team_cummean_netrating_loss
        )

all_opponent_average <- all_team_data %>%
    group_by(team_team) %>%
    mutate(
        #Offensive Statistics
        opponent_cummean_pts = round(cummean(team_pts), 1),
        opponent_cummean_offrating = round(cummean(team_offrating), 1),
        opponent_cummean_fgpct = round(cummean(team_fgpct), 1),
        opponent_cummean_efgpct = round(cummean(team_efgpct), 1),
        opponent_cummean_tspct = round(cummean(team_tspct), 1),
        
        #Defensive Statistics
        opponent_cummean_pts_allowed = round(cummean(team_opponent_pts), 1),
        opponent_cummean_defrating = round(cummean(team_defrating), 1),
        opponent_cummean_fgpct_allowed = round(cummean(team_opponent_fgpct), 1),
        opponent_cummean_efgpct_allowed = round(cummean(team_opponent_fgpct), 1),
        opponent_cummean_tspct_allowed = round(cummean(team_opponent_tspct), 1),
        
        #Other Statistics
        opponent_cummean_reb = round(cummean(team_reb), 1),
        opponent_cummean_tov = round(cummean(team_tov), 1),
        opponent_cummean_netrating = round(cummean(team_netrating), 1),
        
        #Situational Statistics
        #Win
        opponent_cummean_pts_win = case_when(
            team_plusminus > 0 ~ round(cummean(team_pts), 1),
            team_plusminus < 0 ~ NA),
        opponent_cummean_pts_allowed_win = case_when(
            team_plusminus > 0 ~ round(cummean(team_opponent_pts), 1),
            team_plusminus < 0 ~ NA),
        opponent_cummean_netrating_win = case_when(
            team_plusminus > 0 ~ round(cummean(team_netrating), 1),
            team_plusminus < 0 ~ NA),
        #Loss
        opponent_cummean_pts_loss = case_when(
            team_plusminus < 0 ~ round(cummean(team_pts), 1),
            team_plusminus > 0 ~ NA),
        opponent_cummean_pts_allowed_loss = case_when(
            team_plusminus < 0 ~ round(cummean(team_opponent_pts), 1),
            team_plusminus > 0 ~ NA),
        opponent_cummean_netrating_loss = case_when(
            team_plusminus < 0 ~ round(cummean(team_netrating), 1),
            team_plusminus > 0 ~ NA)
        ) %>%
    fill(
        #Offensive Statistics
        opponent_cummean_pts, opponent_cummean_offrating, opponent_cummean_fgpct,
        opponent_cummean_efgpct, opponent_cummean_tspct,
        #Defensive Statistics
        opponent_cummean_pts_allowed, opponent_cummean_defrating, opponent_cummean_fgpct_allowed,
        opponent_cummean_efgpct_allowed, opponent_cummean_tspct_allowed,
        #Other Statistics
        opponent_cummean_reb, opponent_cummean_tov, opponent_cummean_netrating,
        #Situational Statistics
        opponent_cummean_pts_win, opponent_cummean_pts_allowed_win, opponent_cummean_netrating_win, 
        opponent_cummean_pts_loss, opponent_cummean_pts_allowed_loss, opponent_cummean_netrating_loss, .direction = "down"
        ) %>%
    dplyr::select(
        team_team, team_date,
        #Offensive Statistics
        opponent_cummean_pts, opponent_cummean_offrating, opponent_cummean_fgpct,
        opponent_cummean_efgpct, opponent_cummean_tspct,
        #Defensive Statistics
        opponent_cummean_pts_allowed, opponent_cummean_defrating, opponent_cummean_fgpct_allowed,
        opponent_cummean_efgpct_allowed, opponent_cummean_tspct_allowed,
        #Other Statistics
        opponent_cummean_reb, opponent_cummean_tov, opponent_cummean_netrating,
        #Siutational Statistics
        opponent_cummean_pts_win, opponent_cummean_pts_allowed_win, opponent_cummean_netrating_win, 
        opponent_cummean_pts_loss, opponent_cummean_pts_allowed_loss, opponent_cummean_netrating_loss
        )

all_league_average <- all_team_data %>%
    summarize(
        #Major Statistical Categories
        league_avg_pts = round(mean(team_pts, na.rm = TRUE), 1),
        league_avg_pts_allowed = round(mean(team_opponent_pts, na.rm = TRUE), 1),
        league_avg_reb = round(mean(team_reb, na.rm = TRUE), 1),
        league_avg_ast = round(mean(team_ast, na.rm = TRUE), 1),
        league_avg_tov = round(mean(team_tov, na.rm = TRUE), 1),
        #Advanced Metrics
        league_avg_offrating = round(mean(team_offrating, na.rm = TRUE), 1),
        league_avg_defrating = round(mean(team_defrating, na.rm = TRUE), 1),
        league_avg_netrating = round(mean(team_netrating, na.rm = TRUE), 1),
        league_avg_rebpct = round(mean(team_rebpct, na.rm = TRUE), 1),
        league_avg_astpct = round(mean(team_astpct, na.rm = TRUE), 1)
    )

all_team_data <- all_team_data %>%
    left_join(all_team_average, by = c("team_team" = "team_team", "team_date" = "team_date")) %>%
    left_join(all_opponent_average, by = c("team_opponent" = "team_team", "team_date" = "team_date"))

all_team_data <- data.frame(all_team_data, all_league_average)
```

## Data Cleaning 4:

```{r}
all_team_data <- all_team_data %>%
    group_by(team_team) %>%
    mutate(
        #Cumulative Values
        team_cumsum_win = cumsum(ifelse(is.na(team_win), 0, team_win)),
        team_cumsum_loss = cumsum(ifelse(is.na(team_loss), 0, team_loss)),
        team_cumsum_game = team_cumsum_win + team_cumsum_loss,
        
        team_cumsum_blowout_win = cumsum(ifelse(is.na(team_cummean_netrating_win), 0, team_cummean_netrating_win)),
        
        team_cumsum_favored = cumsum(ifelse(is.na(team_favored), 0, team_favored)),
        team_cumsum_upset = cumsum(ifelse(is.na(team_game_outcome_4), 0, team_game_outcome_4)),
        
        #Cumulative Rates
        team_cumrate_win = ifelse(team_cumsum_game == 0, NA, round(team_cumsum_win / team_cumsum_game, 3)),
        team_cumrate_blowout_win = ifelse(team_cumsum_game == 0, NA, round(team_cummean_netrating_win / team_cumsum_win, 3)),
        team_cumrate_favored = ifelse(team_cumsum_game == 0, NA, round(team_cumsum_favored / team_cumsum_game, 3)),
        team_cumrate_upset = ifelse(team_cumsum_favored == 0, NA, round(team_cumsum_upset / team_cumsum_favored, 3))
    ) %>%
    ungroup()
```

------------------------------------------------------------------------

# Multinomial Regression

-   Model

    -   Outcome 1 (Primary): Game Outcome (w/ Magnitude)
    -   Outcome 2 (Primary): Game Outcome
    -   Outcome 3 (Secondary): Game Outcome Magnitude (w/ Primary Outcome Assumption)
    -   Outcome 4 (Secondary): Game Outcome (w/ Previous Condition Met)

## Outcome 1 (Primary): Game Outcome (w/ Magnitude)

### TGO 1: Factor Before Analysis

```{r}
all_team_data <- all_team_data %>%
    mutate(team_game_outcome = factor(team_game_outcome,
                                        levels = c(1, 2, 3, 4),
                                        labels = c("close_win", "close_loss",
                                                   "blowout_win", "blowout_loss")))
```

### TGO 1: Model Building

```{r}
options(scipen = 999)
#Cumulative Average Model

ppg_oppg_model <- multinom(team_game_outcome ~ team_cummean_pts
                          + team_cummean_pts_allowed
                          + opponent_cummean_pts
                          + opponent_cummean_pts_allowed
                          , data = all_team_data)

ppg_oppg_summary <- summary(ppg_oppg_model)
#ppg_oppg_summary

ppg_oppg_z_values <- ppg_oppg_summary$coefficients / ppg_oppg_summary$standard.errors
ppg_oppg_p_values <- (1 -pnorm(abs(ppg_oppg_z_values), 0, 1)) * 2
#ppg_oppg_p_values

#Offensive & Defensive Rating Model
offrtg_defrtg_model <- multinom(team_game_outcome ~ team_cummean_offrating
                           + team_cummean_defrating
                           + opponent_cummean_offrating
                           + opponent_cummean_defrating
                           , data = all_team_data)
offrtg_defrtg_summary <- summary(offrtg_defrtg_model)
offrtg_defrtg_summary

offrtg_defrtg_z_values <- offrtg_defrtg_summary$coefficients / offrtg_defrtg_summary$standard.errors
offrtg_defrtg_p_values <- (1 - pnorm(abs(offrtg_defrtg_z_values), 0, 1)) * 2
offrtg_defrtg_p_values

offrtg_defrtg_exp_coefs <- exp(coef(offrtg_defrtg_summary))
#offrtg_defrtg_exp_coefs
```

### TGO 1: Model Predictions

```{r}
#Points Per Game & Points Allowed Per Game
ppg_oppg_predictions <- fitted(ppg_oppg_summary)
ppg_oppg_predicted_values <- predict(ppg_oppg_model, newdata = all_team_data, type = "probs")
ppg_oppg_data <- cbind(all_team_data, ppg_oppg_predicted_values)


#Offensive & Defensive Rating Model
offrtg_defrtg_predictions <- fitted(offrtg_defrtg_summary)
offrtg_defrtg_predicted_values <- predict(offrtg_defrtg_model, newdata = all_team_data, type = "probs")
offrtg_defrtg_data <- cbind(all_team_data, offrtg_defrtg_predicted_values)
```

### TGO 1: Data Cleaning 1: Predictions in Data Frame

```{r}
ppg_oppg_data <- ppg_oppg_data %>%
    mutate(close_win = round(close_win * 100, 1),
           close_loss = round(close_loss * 100, 1),
           blowout_win = round(blowout_win * 100, 1),
           blowout_loss = round(blowout_loss * 100, 1))

offrtg_defrtg_data <- offrtg_defrtg_data %>%
    mutate(close_win = round(close_win * 100, 1),
           close_loss = round(close_loss * 100, 1),
           blowout_win = round(blowout_win * 100, 1),
           blowout_loss = round(blowout_loss * 100, 1))
```

------------------------------------------------------------------------

# Logistic Regression

## Outcome 2 (Primary): Game Outcome

```{r}
winloss_model <- glm(team_game_outcome_2 ~ team_home
                 + team_cummean_offrating
                 + team_cummean_defrating
                 + opponent_cummean_offrating
                 + opponent_cummean_defrating
                 , data = all_team_data, family = "binomial")

winloss_model_summary <- summary(winloss_model)
winloss_model_summary
```

### TGO 2: Model Predictors Data Frame

```{r}
#Model Estimate to Main Data Frame
winloss_predictions <- fitted(winloss_model)
winloss_predicted_values <- predict(winloss_model, newdata = all_team_data, type = "response")
all_team_data <- cbind(all_team_data, winloss_predicted_values)

#Cleaning Up Probability
all_team_data <- all_team_data %>%
    mutate(winloss_predicted_values = round(100 * winloss_predicted_values, 1))
```

## Outcome 3 (Secondary): Game Outcome Magnitude (w/ Primary Outcome Assumption)

```{r eval=FALSE, include=FALSE}
blowout_model <- glm(team_game_outcome_3 ~ team_cummean_pts_win
                     + team_cummean_pts_allowed_win
                 , data = all_team_data, family = "binomial")

blowout_model_summary <- summary(blowout_model)
blowout_model_summary
```

### TGO 3: Model Predictors Data Frame

```{r eval=FALSE, include=FALSE}
blowout_predictions <- fitted(blowout_model)
blowout_predicted_values <- predict(blowout_model, newdata = all_team_data, type = "response")
all_team_data <- cbind(all_team_data, blowout_predicted_values)
```

## Outcome 4 (Secondary): Game Outcome (w/ Previous Condition Met)

```{r}
upset_model <- glm(team_game_outcome_4 ~ team_cumrate_upset
                   + team_spread
                   , data = all_team_data, family = "binomial")

upset_model_summary <- summary(upset_model)
upset_model_summary
```

### TGO 4: Model Predictors Data Frame

```{r}
#Model Estimate to Main Data Frame
upset_predictions <- fitted(upset_model)
upset_predicted_values <- predict(upset_model, newdata = all_team_data, type = "response")
all_team_data <- cbind(all_team_data, upset_predicted_values)

#Cleaning Up Probability
all_team_data <- all_team_data %>%
    mutate(upset_predicted_values = round(100 * upset_predicted_values, 1))
```

------------------------------------------------------------------------

# Machine Learning

```{r eval=FALSE, include=FALSE}
set.seed(123)
ml_all_team_data <- na.omit(all_team_data)
```

## Splitting Data & Creating Models

```{r eval=FALSE, include=FALSE}
#Splitting Data
ml_team_split <- initial_split(ml_all_team_data, prop = .60)
ml_team_train <- training(ml_team_split)
ml_team_test <- testing(ml_team_split)

#Models
ml_team_outcome_fd <- multinom(team_game_outcome ~ team_moneyline,
                               data = ml_team_train)

ml_team_outcome <- multinom(team_game_outcome ~ team_cummean_offrating
                           + team_cummean_defrating
                           + opponent_cummean_offrating
                           + opponent_cummean_defrating
                           , data = ml_team_train)

summary(ml_team_outcome_fd)
summary(ml_team_outcome)
```

## Cross Validation

```{r eval=FALSE, include=FALSE}
cv_ml_team_outcome_fd <- train(team_game_outcome ~ team_moneyline
                            , data = ml_team_train
                            , method = "multinom"
                            , trControl = trainControl(method = "cv", number = 10))

cv_ml_team_outcome <- train(team_game_outcome ~ team_cummean_offrating
                           + team_cummean_defrating
                           + opponent_cummean_offrating
                           + opponent_cummean_defrating
                           , data = ml_team_train
                           , method = "multinom"
                           , trControl = trainControl(method = "cv", number = 10))



summary(
    resamples(
        list(
            model1 = cv_ml_team_outcome_fd,
            model2 = cv_ml_team_outcome
        )
    )
)$statistics$Accuracy
```

```{r eval=FALSE, include=FALSE}
pred_class <- predict(cv_ml_team_outcome, ml_team_train)
confusionMatrix(
    data = pred_class,
    reference = relevel(ml_team_train$team_game_outcome, ref = 1)
)
```
