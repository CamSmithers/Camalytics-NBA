---
title: "Multinomial Regression Analysis"
author: "Cam Smithers"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Camalytics

## Overview

## Loading Packages

```{r}
library(dplyr)
library(ggplot2)
library(tidyverse)
library(foreign)
library(nnet)
library(readr)
library(rsample)
library(caret)
library(h2o)
library(modeldata)
library(vip)
library(ROCR)
```

## Loading in All Data

```{r warning=FALSE}
#Running script that contains all data (teams and players)
source("/Users/camsmithers/Desktop/NBA Project/Main/Data/DataScript.R")

#Joining all team data into one data frame
all_team_data <- team_traditional %>%
    left_join(team_advanced, by = c("team", 'date')) %>% 
    left_join(team_misc, by = c("team", "date")) %>%
    left_join(team_scoring, by = c("team", "date")) %>%
    left_join(team_outcome, by = c("team", "date"))
```

## Data Cleaning 1: General Cleaning

```{r}
all_team_data <- all_team_data %>%
    dplyr::select(-opponent, -opponent.y, -opponent.x.x, -opponent.y.y, -home, -home.y, -home.x.x,
           -home.y.y, -blk.y, -pf.y) %>% #Removing duplicated columns
    rename("opponent" = "opponent.x", "blk" = "blk.x", "pf" = "pf.x", "home" = "home.x") %>% #Wanted to keep specific duplicated to be used as the main
    dplyr::select(team, home, everything()) #Re-ordering variables for better visualization
team_temporary_df <- all_team_data %>% #Temporary data frame used add opponents' points scored
    dplyr::select(team, opponent, date, pts) %>%
    rename("team_1" = "team", "team_2" = "opponent")

all_team_data <- all_team_data %>% #Joining opponent points to original data frame
    left_join(team_temporary_df, by = c("team" = "team_2", "date")) %>%
    rename("opponent_pts" = "pts.y", "pts" = "pts.x") %>%
    dplyr::select(-team_1)

all_team_data <- all_team_data %>% #Re-ordering for better visualization
    dplyr::select(date, home, team, pts, opponent, opponent_pts, everything()) %>%
    rename_with(~ paste0("team_", .)) #Adding _team to each observation for easier recognition of variable for later cleaning, model building, and joins
```

## Data Cleaning 2: Creating Variables for Outcomes

1.  Primary Outcome: Game Outcome Type
2.  Changing Variable to Factor
3.  Creating Binary Variables for Primary Outcomes
4.  Secondary Outcome: Game Outcome without Magnitude

```{r}
all_team_data <- all_team_data %>%
    #Primary Outcome: Types of Outcomes
    mutate(team_game_outcome = case_when(
        team_plusminus > 0 & team_plusminus <= 10 ~ 1,
        team_plusminus < 0 & team_plusminus >= -10 ~ 2,
        team_plusminus > 10 ~ 3,
        team_plusminus < -10 ~ 4
    )) %>%
    #Secondary Outcome: Sub-Type of Outcome
    mutate(team_win = ifelse(team_game_outcome == 1 | team_game_outcome == 3, 1, 0),
           team_loss = ifelse(team_game_outcome == 2 | team_game_outcome == 4, 1, 0))
    
```

## Data Cleaning 3: Team Averages

```{r}
all_team_average <- all_team_data %>%
    group_by(team_team) %>%
    summarize(
        #Major Statistical Categories
        team_avg_pts = round(mean(team_pts, na.rm = TRUE), 1),
        team_avg_pts_allowed = round(mean(team_opponent_pts, na.rm = TRUE), 1),
        team_avg_reb = round(mean(team_reb, na.rm = TRUE), 1),
        team_avg_ast = round(mean(team_ast, na.rm = TRUE), 1),
        team_avg_tov = round(mean(team_tov, na.rm = TRUE), 1),
        #Advanced Metrics
        team_avg_offrating = round(mean(team_offrating, na.rm = TRUE), 1),
        team_avg_defrating = round(mean(team_defrating, na.rm = TRUE), 1),
        team_avg_netrating = round(mean(team_netrating, na.rm = TRUE), 1),
        team_avg_rebpct = round(mean(team_rebpct, na.rm = TRUE), 1),
        team_avg_astpct = round(mean(team_astpct, na.rm = TRUE), 1)
    )

all_team_average_2 <- all_team_data %>%
    group_by(team_team) %>%
    mutate(team_cummean_offrating = round(cummean(team_offrating), 1),
           team_cummean_defrating = round(cummean(team_defrating), 1),
           team_cummean_netrating = round(cummean(team_netrating), 1)) %>%
    fill(team_cummean_offrating, team_cummean_defrating, team_cummean_netrating, .direction = "down") %>%
    ungroup() %>%
    dplyr::select(team_team, team_date, team_cummean_offrating,
                  team_cummean_defrating, team_cummean_netrating)

all_opponent_average <- all_team_data %>%
    group_by(team_team) %>%
    summarize(
        #Major Statistical Categories
        opponent_avg_pts = round(mean(team_pts, na.rm = TRUE), 1),
        opponent_avg_pts_allowed = round(mean(team_opponent_pts, na.rm = TRUE), 1),
        opponent_avg_reb = round(mean(team_reb, na.rm = TRUE), 1),
        opponent_avg_ast = round(mean(team_ast, na.rm = TRUE), 1),
        opponent_avg_tov = round(mean(team_tov, na.rm = TRUE), 1),
        #Advanced Metrics
        opponent_avg_offrating = round(mean(team_offrating, na.rm = TRUE), 1),
        opponent_avg_defrating = round(mean(team_defrating, na.rm = TRUE), 1),
        opponent_avg_netrating = round(mean(team_netrating, na.rm = TRUE), 1),
        opponent_avg_rebpct = round(mean(team_rebpct, na.rm = TRUE), 1),
        opponent_avg_astpct = round(mean(team_astpct, na.rm = TRUE), 1)
    )

all_opponent_average_2 <- all_team_data %>%
    group_by(team_team) %>%
    mutate(opponent_cummean_offrating = round(cummean(team_offrating), 1),
           opponent_cummean_defrating = round(cummean(team_defrating), 1),
           opponent_cummean_netrating = round(cummean(team_netrating))) %>%
    fill(opponent_cummean_offrating, opponent_cummean_defrating, opponent_cummean_netrating, .direction = "down") %>%
    ungroup() %>%
    dplyr::select(team_team, team_date, opponent_cummean_offrating,
                  opponent_cummean_defrating, opponent_cummean_netrating)

all_league_average <- all_team_data %>%
    summarize(
        #Major Statistical Categories
        league_avg_pts = round(mean(team_pts, na.rm = TRUE), 1),
        league_avg_pts_allowed = round(mean(team_opponent_pts, na.rm = TRUE), 1),
        league_avg_reb = round(mean(team_reb, na.rm = TRUE), 1),
        league_avg_ast = round(mean(team_ast, na.rm = TRUE), 1),
        league_avg_tov = round(mean(team_tov, na.rm = TRUE), 1),
        #Advanced Metrics
        league_avg_offrating = round(mean(team_offrating, na.rm = TRUE), 1),
        league_avg_defrating = round(mean(team_defrating, na.rm = TRUE), 1),
        league_avg_netrating = round(mean(team_netrating, na.rm = TRUE), 1),
        league_avg_rebpct = round(mean(team_rebpct, na.rm = TRUE), 1),
        league_avg_astpct = round(mean(team_astpct, na.rm = TRUE), 1)
    )

all_team_data <- all_team_data %>%
    left_join(all_team_average, by = c("team_team" = "team_team")) %>%
    left_join(all_opponent_average, by = c("team_opponent" = "team_team")) %>%
    left_join(all_team_average_2, by = c("team_team", "team_date")) %>%
    left_join(all_opponent_average_2, by = c("team_opponent" = "team_team", "team_date"))

all_team_data <- data.frame(all_team_data, all_league_average)
```

## Data Cleaning 4: Metrics for Measurement

```{r}
all_team_data <- all_team_data %>%
    #Statistics Above League Average
    mutate(pts_bt_league = ifelse(team_avg_pts > league_avg_pts, 1, 0),
           pts_allowed_bt_league = ifelse(team_avg_pts < league_avg_pts_allowed, 1, 0),
           reb_bt_league = ifelse(team_avg_reb > league_avg_reb, 1, 0),
           ast_bt_league = ifelse(team_avg_ast > league_avg_ast, 1, 0),
           tov_bt_league = ifelse(team_avg_tov < league_avg_tov, 1, 0),
           offrating_bt_league = ifelse(team_avg_offrating > league_avg_offrating, 1, 0),
           defrating_bt_league = ifelse(team_avg_defrating < league_avg_defrating, 1, 0),
           netrating_bt_league = ifelse(team_avg_netrating > league_avg_netrating, 1, 0),
           rebpct_bt_league = ifelse(team_avg_rebpct > league_avg_rebpct, 1, 0),
           astpct_bt_league = ifelse(team_avg_astpct > league_avg_astpct, 1, 0)) %>%
    #Count of Statistics Above League Average
    mutate(stats_bt_league = pts_bt_league + pts_allowed_bt_league + reb_bt_league + tov_bt_league + 
               offrating_bt_league + defrating_bt_league + netrating_bt_league + 
               rebpct_bt_league + astpct_bt_league)
```

# Model Building

## Factor Before Analysis

```{r}
all_team_data <- all_team_data %>%
    mutate(team_game_outcome = factor(team_game_outcome,
                                        levels = c(1, 2, 3, 4),
                                        labels = c("close_win", "close_loss",
                                                   "blowout_win", "blowout_loss")))
```


```{r}
options(scipen = 999)
#Cumulative Average Model
offrtg_defrtg_model <- multinom(team_game_outcome ~ team_cummean_offrating
                           + team_cummean_defrating
                           + opponent_cummean_offrating
                           + opponent_cummean_defrating
                           , data = all_team_data)
offrtg_defrtg_summary <- summary(offrtg_defrtg_model)
offrtg_defrtg_summary

offrtg_defrtg_z_values <- offrtg_defrtg_summary$coefficients / offrtg_defrtg_summary$standard.errors
offrtg_defrtg_p_values <- (1 - pnorm(abs(offrtg_defrtg_z_values), 0, 1)) * 2
offrtg_defrtg_p_values

offrtg_defrtg_exp_coefs <- exp(coef(offrtg_defrtg_summary))
offrtg_defrtg_exp_coefs
```

## Model Predictions

### Cumulative Average Model

```{r}
#Current Data Set

#Cumulative Average Model
offrtg_defrtg_predictions <- fitted(offrtg_defrtg_summary)
offrtg_defrtg_predicted_values <- predict(offrtg_defrtg_model, newdata = all_team_data, type = "probs")
all_team_data <- cbind(all_team_data, offrtg_defrtg_predicted_values)
```

## Data Cleaning 5: Predictions in Data Frame

### Cumulative Average Model

```{r}
all_team_data <- all_team_data %>%
    mutate(close_win = round(close_win * 100, 1),
           close_loss = round(close_loss * 100, 1),
           blowout_win = round(blowout_win * 100, 1),
           blowout_loss = round(blowout_loss * 100, 1))

#View(all_team_data)
```

# Machine Learning

```{r eval=FALSE, include=FALSE}
set.seed(123)
ml_all_team_data <- na.omit(all_team_data)
```

## Splitting Data & Creating Models

```{r eval=FALSE, include=FALSE}
#Splitting Data
ml_team_split <- initial_split(ml_all_team_data, prop = .60)
ml_team_train <- training(ml_team_split)
ml_team_test <- testing(ml_team_split)

#Models
ml_team_outcome_fd <- multinom(team_game_outcome ~ team_moneyline,
                               data = ml_team_train)

ml_team_outcome <- multinom(team_game_outcome ~ team_cummean_offrating
                           + team_cummean_defrating
                           + opponent_cummean_offrating
                           + opponent_cummean_defrating
                           , data = ml_team_train)

summary(ml_team_outcome_fd)
summary(ml_team_outcome)
```

## Cross Validation

```{r eval=FALSE, include=FALSE}
cv_ml_team_outcome_fd <- train(team_game_outcome ~ team_moneyline
                            , data = ml_team_train
                            , method = "multinom"
                            , trControl = trainControl(method = "cv", number = 10))

cv_ml_team_outcome <- train(team_game_outcome ~ team_cummean_offrating
                           + team_cummean_defrating
                           + opponent_cummean_offrating
                           + opponent_cummean_defrating
                           , data = ml_team_train
                           , method = "multinom"
                           , trControl = trainControl(method = "cv", number = 10))



summary(
    resamples(
        list(
            model1 = cv_ml_team_outcome_fd,
            model2 = cv_ml_team_outcome
        )
    )
)$statistics$Accuracy
```

```{r eval=FALSE, include=FALSE}
pred_class <- predict(cv_ml_team_outcome, ml_team_train)
confusionMatrix(
    data = pred_class,
    reference = relevel(ml_team_train$team_game_outcome, ref = 1)
)
```