---
title: "Multinomial Regression Analysis"
author: "Cam Smithers"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Camalytics

## Loading Packages

```{r}
library(dplyr)
library(ggplot2)
library(tidyverse)
library(foreign)
library(nnet)
library(readr)
```

## Loading in All Data

```{r warning=FALSE}
#Running script that contains all data (teams and players)
source("/Users/camsmithers/Desktop/NBA Project/Main/Data/DataScript.R")

#Joining all team data into one data frame
all_team_data <- team_traditional %>%
    left_join(team_advanced, by = c("team", 'date')) %>% 
    left_join(team_misc, by = c("team", "date")) %>%
    left_join(team_scoring, by = c("team", "date")) %>%
    left_join(team_outcome, by = c("team", "date"))
```

## Data Cleaning 1: General Cleaning

```{r}
all_team_data <- all_team_data %>%
    dplyr::select(-opponent, -opponent.y, -opponent.x.x, -opponent.y.y, -home, -home.y, -home.x.x,
           -home.y.y, -blk.y, -pf.y) %>% #Removing duplicated columns
    rename("opponent" = "opponent.x", "blk" = "blk.x", "pf" = "pf.x", "home" = "home.x") %>% #Wanted to keep specific duplicated to be used as the main
    dplyr::select(team, home, everything()) #Re-ordering variables for better visualization
team_temporary_df <- all_team_data %>% #Temporary data frame used add opponents' points scored
    dplyr::select(team, opponent, date, pts) %>%
    rename("team_1" = "team", "team_2" = "opponent")

all_team_data <- all_team_data %>% #Joining opponent points to original data frame
    left_join(team_temporary_df, by = c("team" = "team_2", "date")) %>%
    rename("opponent_pts" = "pts.y", "pts" = "pts.x") %>%
    dplyr::select(-team_1)

all_team_data <- all_team_data %>% #Re-ordering for better visualization
    dplyr::select(date, home, team, pts, opponent, opponent_pts, everything()) %>%
    rename_with(~ paste0("team_", .)) #Adding _team to each observation for easier recognition of variable for later cleaning, model building, and joins
```

## Data Cleaning 2: Creating Variables for Outcomes

1.  Primary Outcome: Game Outcome Type
2.  Changing Variable to Factor
3.  Creating Binary Variables for Primary Outcomes
4.  Secondary Outcome: Game Outcome without Magnitude

```{r}
all_team_data <- all_team_data %>%
    #Primary Outcome: Types of Outcomes
    mutate(team_game_outcome = case_when(
        team_plusminus > 0 & team_plusminus <= 10 ~ 1,
        team_plusminus < 0 & team_plusminus >= -10 ~ 2,
        team_plusminus > 10 ~ 3,
        team_plusminus < -10 ~ 4
    )) %>%
    #Changing Outcome to Factor for Analysis
    mutate(team_game_outcome = factor(team_game_outcome,
                                        levels = c(1, 2, 3, 4),
                                        labels = c("close_win", "close_loss", "blowout_win", "blowout_loss"))) %>%
    #Secondary Outcome: Sub-Type of Outcome
    mutate(team_win = ifelse(team_game_outcome == 1 | team_game_outcome == 3, 1, 0),
           team_loss = ifelse(team_game_outcome == 2 | team_game_outcome == 4, 1, 0))
    
```

## Data Cleaning 3: Team Averages

```{r}
all_team_average <- all_team_data %>%
    group_by(team_team) %>%
    summarize(
        #Major Statistical Categories
        team_avg_pts = round(mean(team_pts, na.rm = TRUE), 1),
        team_avg_pts_allowed = round(mean(team_opponent_pts, na.rm = TRUE), 1),
        team_avg_reb = round(mean(team_reb, na.rm = TRUE), 1),
        team_avg_ast = round(mean(team_ast, na.rm = TRUE), 1),
        team_avg_tov = round(mean(team_tov, na.rm = TRUE), 1),
        #Advanced Metrics
        team_avg_offrating = round(mean(team_offrating, na.rm = TRUE), 1),
        team_avg_defrating = round(mean(team_defrating, na.rm = TRUE), 1),
        team_avg_netrating = round(mean(team_netrating, na.rm = TRUE), 1),
        team_avg_rebpct = round(mean(team_rebpct, na.rm = TRUE), 1),
        team_avg_astpct = round(mean(team_astpct, na.rm = TRUE), 1)
    )

all_team_average_2 <- all_team_data %>%
    group_by(team_team) %>%
    mutate(team_cummean_offrating = round(cummean(team_offrating), 1),
           team_cummean_defrating = round(cummean(team_defrating), 1)) %>%
    fill(team_cummean_offrating, team_cummean_defrating, .direction = "down") %>%
    ungroup() %>%
    select(team_team, team_date, team_cummean_offrating, team_cummean_defrating)

all_opponent_average <- all_team_data %>%
    group_by(team_team) %>%
    summarize(
        #Major Statistical Categories
        opponent_avg_pts = round(mean(team_pts, na.rm = TRUE), 1),
        opponent_avg_pts_allowed = round(mean(team_opponent_pts, na.rm = TRUE), 1),
        opponent_avg_reb = round(mean(team_reb, na.rm = TRUE), 1),
        opponent_avg_ast = round(mean(team_ast, na.rm = TRUE), 1),
        opponent_avg_tov = round(mean(team_tov, na.rm = TRUE), 1),
        #Advanced Metrics
        opponent_avg_offrating = round(mean(team_offrating, na.rm = TRUE), 1),
        opponent_avg_defrating = round(mean(team_defrating, na.rm = TRUE), 1),
        opponent_avg_netrating = round(mean(team_netrating, na.rm = TRUE), 1),
        opponent_avg_rebpct = round(mean(team_rebpct, na.rm = TRUE), 1),
        opponent_avg_astpct = round(mean(team_astpct, na.rm = TRUE), 1)
    )

all_opponent_average_2 <- all_team_data %>%
    group_by(team_team) %>%
    mutate(opponent_cummean_offrating = round(cummean(team_offrating), 1),
           opponent_cummean_defrating = round(cummean(team_defrating), 1)) %>%
    fill(opponent_cummean_offrating, opponent_cummean_defrating, .direction = "down") %>%
    ungroup() %>%
    select(team_team, team_date, opponent_cummean_offrating, opponent_cummean_defrating)

all_league_average <- all_team_data %>%
    summarize(
        #Major Statistical Categories
        league_avg_pts = round(mean(team_pts, na.rm = TRUE), 1),
        league_avg_pts_allowed = round(mean(team_opponent_pts, na.rm = TRUE), 1),
        league_avg_reb = round(mean(team_reb, na.rm = TRUE), 1),
        league_avg_ast = round(mean(team_ast, na.rm = TRUE), 1),
        league_avg_tov = round(mean(team_tov, na.rm = TRUE), 1),
        #Advanced Metrics
        league_avg_offrating = round(mean(team_offrating, na.rm = TRUE), 1),
        league_avg_defrating = round(mean(team_defrating, na.rm = TRUE), 1),
        league_avg_netrating = round(mean(team_netrating, na.rm = TRUE), 1),
        league_avg_rebpct = round(mean(team_rebpct, na.rm = TRUE), 1),
        league_avg_astpct = round(mean(team_astpct, na.rm = TRUE), 1)
    )

all_team_data <- all_team_data %>%
    left_join(all_team_average, by = c("team_team" = "team_team")) %>%
    left_join(all_opponent_average, by = c("team_opponent" = "team_team")) %>%
    left_join(all_team_average_2, by = c("team_team", "team_date")) %>%
    left_join(all_opponent_average_2, by = c("team_opponent" = "team_team", "team_date"))

all_team_data <- data.frame(all_team_data, all_league_average)
```

## Data Cleaning 4: Metrics for Measurement

```{r}
all_team_data <- all_team_data %>%
    #Statistics Above League Average
    mutate(pts_bt_league = ifelse(team_avg_pts > league_avg_pts, 1, 0),
           pts_allowed_bt_league = ifelse(team_avg_pts < league_avg_pts_allowed, 1, 0),
           reb_bt_league = ifelse(team_avg_reb > league_avg_reb, 1, 0),
           ast_bt_league = ifelse(team_avg_ast > league_avg_ast, 1, 0),
           tov_bt_league = ifelse(team_avg_tov < league_avg_tov, 1, 0),
           offrating_bt_league = ifelse(team_avg_offrating > league_avg_offrating, 1, 0),
           defrating_bt_league = ifelse(team_avg_defrating < league_avg_defrating, 1, 0),
           netrating_bt_league = ifelse(team_avg_netrating > league_avg_netrating, 1, 0),
           rebpct_bt_league = ifelse(team_avg_rebpct > league_avg_rebpct, 1, 0),
           astpct_bt_league = ifelse(team_avg_astpct > league_avg_astpct, 1, 0)) %>%
    #Count of Statistics Above League Average
    mutate(stats_bt_league = pts_bt_league + pts_allowed_bt_league + reb_bt_league + tov_bt_league + 
               offrating_bt_league + defrating_bt_league + netrating_bt_league + 
               rebpct_bt_league + astpct_bt_league)
```

# Model Building

```{r}
options(scipen = 999)
#Cumulative Average Model

#all_team_data$team_game_outcome <- relevel(all_team_data$team_game_outcome, ref = "x")

cumulative_avg <- multinom(team_game_outcome ~ team_cummean_offrating
                           + team_cummean_defrating
                           + opponent_cummean_offrating
                           + opponent_cummean_defrating, data = all_team_data)
cumulative_avg_summary <- summary(cumulative_avg)
cumulative_avg_summary

cumulative_avg_z_values <- cumulative_avg_summary$coefficients / cumulative_avg_summary$standard.errors
cumulative_avg_p_values <- (1 - pnorm(abs(cumulative_avg_z_values), 0, 1)) * 2
cumulative_avg_p_values

cumulative_avg_exp_coefs <- exp(coef(cumulative_avg_summary))
cumulative_avg_exp_coefs
```

## Model Predictions

### Cumulative Average Model

```{r}
#Current Data Set

#Cumulative Average Model
cumulative_avg_predictions <- fitted(cumulative_avg_summary)
cumulative_avg_predicted_values <- predict(cumulative_avg, newdata = all_team_data, type = "probs")
all_team_data <- cbind(all_team_data, cumulative_avg_predicted_values)
```

## Data Cleaning 5: Predictions in Data Frame

### Cumulative Average Model

```{r}
all_team_data <- all_team_data %>%
    mutate(close_win = round(close_win * 100, 1),
           close_loss = round(close_loss * 100, 1),
           blowout_win = round(blowout_win * 100, 1),
           blowout_loss = round(blowout_loss * 100, 1))

#View(all_team_data)
```