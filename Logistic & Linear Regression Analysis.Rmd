---
title: "Logistic & Linear Regression Analysis"
author: "Cam Smithers
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Sports Betting Analysis

## Loading Packages

```{r}
library(readxl)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(readr)
library(purrr)
library(stringr)
library(broom)
library(nnet)
```

# Data Cleaning

## Loading in All Data

```{r warning=FALSE}
#Running script that contains all data (teams and players)
source("/Users/camsmithers/Desktop/NBA Project/Main/Data/DataScript.R")

#Joining all team data into one data frame
team_data <- team_traditional %>%
    left_join(team_advanced, by = c("team", 'date')) %>% 
    left_join(team_misc, by = c("team", "date")) %>%
    left_join(team_scoring, by = c("team", "date")) %>%
    left_join(team_outcome, by = c("team", "date"))
```

## Data Cleaning 1: General Cleaning

1.  Removing duplicates, renaming, and re-ordering
2.  Adding the opposing team and some of their statistics
3.  Re-ordering columns for better visualization when checking data

```{r}
team_data <- team_data %>%
    select(-opponent, -opponent.y, -opponent.x.x, -opponent.y.y, -home, -home.y, -home.x.x,
           -home.y.y, -blk.y, -pf.y) %>% #Removing duplicated columns
    rename("opponent" = "opponent.x", "blk" = "blk.x", "pf" = "pf.x", "home" = "home.x") %>% #Wanted to keep specific duplicated to be used as the main
    select(team, home, everything()) #Re-ordering variables for better visualization
team_temporary_df <- team_data %>% #Temporary data frame used add opponents' points scored
    select(team, opponent, date, pts) %>%
    rename("team_1" = "team", "team_2" = "opponent")

team_data <- team_data %>% #Joining opponent points to original data frame
    left_join(team_temporary_df, by = c("team" = "team_2", "date")) %>%
    rename("opponent_pts" = "pts.y", "pts" = "pts.x") %>%
    select(-team_1)

team_data <- team_data %>% #Re-ordering for better visualization
    select(date, home, team, pts, opponent, opponent_pts, everything()) %>%
    rename_with(~ paste0("team_", .)) #Adding _team to each observation for easier recognition of variable for later cleaning, model building, and joins
```

## Data Cleaning 2: Adding Important Outcomes

Mutates' In Order

1.  Creating variable for team winning.
2.  Creating variable for team winning, this is used for later operations (ex: cumulative wins for total sum, calculating win percentage)
3.  Creating variable for team losing, this is used for later operations (ex: cumulative wins for total sum, calculating win percentage)
4.  Combining points between both teams.
5.  Determining whether the teams' combined total points is higher than the predicted total.
6.  Determining whether the outcome of the game was close or not.
7.  Determining whether each team covered the spread.
8.  Was a team who was favored lose?

```{r}
team_data <- team_data %>%
    mutate(team_winloss = ifelse(team_plusminus > 0, 1, 0)) %>%
    mutate(team_win = ifelse(team_plusminus > 0, 1, 0)) %>%
    mutate(team_loss = ifelse(team_plusminus < 0, 1, 0)) %>%
    mutate(team_combined_pts = team_pts + team_opponent_pts) %>%
    mutate(team_cover_gametotal = ifelse(team_pts + team_opponent_pts > team_gametotal, 1, 0)) %>%
    mutate(team_close_win = case_when(
        team_plusminus <= 10 & team_plusminus > 0 ~ 1,
        team_plusminus > 10 ~ 0,
        TRUE ~ NA
    )) %>%
    mutate(team_point_differential = abs(team_plusminus)) %>%
    mutate(team_cover_spread = case_when(
        team_point_differential == team_spread ~ NA, 
        team_point_differential > team_spread & team_favored == 1 ~ 1,
        team_point_differential < team_spread & team_favored == 1 ~ 0, 
        team_point_differential < team_spread & team_favored == 0 ~ 1, 
        team_point_differential > team_spread & team_favored == 0 ~ 0
    )) %>%
    mutate(team_upset = case_when(
        team_favored == 1 & team_plusminus < 0 ~ 1,
        team_favored == 1 & team_plusminus > 0 ~ 0,
        TRUE ~ NA
    )) %>%
    mutate(team_not_favored = ifelse(team_favored == 0, 1, 0)) %>%
    mutate(team_create_upset = case_when(
        team_favored == 0 & team_plusminus > 0 ~ 1,
        team_favored == 0 & team_plusminus < 0 ~ 0,
        TRUE ~ NA
    ))
```

## Data Cleaning 4: Team Averages

1.  Team Average
    1.  All of a team's games
    2.  A team's last 10 games
    3.  Combination of 1 & 2
        1.  Creating weighted averages, which take into account all teams data and the last 10 games.
2.  Opponent Average (Identical to Team Average; however, it will be joined back to original data frame so the opponent data is added accordingly)
3.  League Average

```{r}
#Team Season Averages
average_team <- team_data %>% #Creating data frame with averages of specific statistics for each team
    group_by(team_team) %>%
    summarize(
        team_pts = round(mean(team_pts, na.rm = TRUE), 2), 
        team_reb = round(mean(team_reb, na.rm = TRUE), 2),
        team_ast = round(mean(team_ast, na.rm = TRUE), 2),
        team_fgpct = round(mean(team_fgpct, na.rm = TRUE), 2),
        team_threefgpct = round(mean(team_threefgpct, na.rm = TRUE), 2),
        team_tspct = round(mean(team_tspct, na.rm = TRUE), 2), 
        team_offrating = round(mean(team_offrating, na.rm = TRUE), 2),
        team_defrating = round(mean(team_defrating, na.rm = TRUE), 2),
        team_netrating = round(mean(team_netrating, na.rm = TRUE), 2),
        team_tov = round(mean(team_tov, na.rm = TRUE), 2),
        team_plusminus = round(mean(team_plusminus, na.rm = TRUE), 2)
    ) %>%
    rename_with(~ paste0("avg_", .)) #Renaming for easier recognition of variables

#Team Last 10 Games Averages
average_team_last10 <- team_data %>% #Creating data frame with averages of specific statistics for each team
    group_by(team_team) %>%
    slice_tail(n = 10) %>%
    summarize(
        team_pts = round(mean(team_pts, na.rm = TRUE), 2), 
        team_reb = round(mean(team_reb, na.rm = TRUE), 2),
        team_ast = round(mean(team_ast, na.rm = TRUE), 2),
        team_fgpct = round(mean(team_fgpct, na.rm = TRUE), 2),
        team_threefgpct = round(mean(team_threefgpct, na.rm = TRUE), 2),
        team_tspct = round(mean(team_tspct, na.rm = TRUE), 2), 
        team_offrating = round(mean(team_offrating, na.rm = TRUE), 2),
        team_defrating = round(mean(team_defrating, na.rm = TRUE), 2),
        team_netrating = round(mean(team_netrating, na.rm = TRUE), 2),
        team_tov = round(mean(team_tov, na.rm = TRUE), 2),
        team_plusminus = round(mean(team_plusminus, na.rm = TRUE), 2)
    ) %>%
    rename_with(~ paste0("avg_", ., "_last10")) #Renaming for easier recognition of variables

#Joining Team Average Data Frames
average_team_full <- average_team %>% #Joining team data from beginning of season to present day and the last ten games
    left_join(average_team_last10, by = c("avg_team_team" = "avg_team_team_last10"))

#Team Season Averages (Used to Join via Opponents Later)
opponent_average_team <- team_data %>%
    group_by(team_team) %>%
    summarize(
        opponent_team_pts = round(mean(team_pts, na.rm = TRUE), 2), 
        opponent_team_reb = round(mean(team_reb, na.rm = TRUE), 2),
        opponent_team_ast = round(mean(team_ast, na.rm = TRUE), 2),
        opponent_team_fgpct = round(mean(team_fgpct, na.rm = TRUE), 2),
        opponent_team_threefgpct = round(mean(team_threefgpct, na.rm = TRUE), 2),
        opponent_team_tspct = round(mean(team_tspct, na.rm = TRUE), 2), 
        opponent_team_offrating = round(mean(team_offrating, na.rm = TRUE), 2),
        opponent_team_defrating = round(mean(team_defrating, na.rm = TRUE), 2),
        opponent_team_netrating = round(mean(team_netrating, na.rm = TRUE), 2),
        opponent_team_tov = round(mean(team_tov, na.rm = TRUE), 2),
        opponent_team_plusminus = round(mean(team_plusminus, na.rm = TRUE), 2)
    ) %>%
    rename_with(~ paste0("avg_", .))

#Team Last 10 Games Averages (Used to Join via Opponents Later)
opponent_average_team_last10 <- team_data %>%
    group_by(team_team) %>%
    slice_tail(n = 10) %>%
    summarize(
        opponent_team_pts = round(mean(team_pts, na.rm = TRUE), 2), 
        opponent_team_reb = round(mean(team_reb, na.rm = TRUE), 2),
        opponent_team_ast = round(mean(team_ast, na.rm = TRUE), 2),
        opponent_team_fgpct = round(mean(team_fgpct, na.rm = TRUE), 2),
        opponent_team_threefgpct = round(mean(team_threefgpct, na.rm = TRUE), 2),
        opponent_team_tspct = round(mean(team_tspct, na.rm = TRUE), 2), 
        opponent_team_offrating = round(mean(team_offrating, na.rm = TRUE), 2),
        opponent_team_defrating = round(mean(team_defrating, na.rm = TRUE), 2),
        opponent_team_netrating = round(mean(team_netrating, na.rm = TRUE), 2),
        opponent_team_tov = round(mean(team_tov, na.rm = TRUE), 2),
        opponent_team_plusminus = round(mean(team_plusminus, na.rm = TRUE), 2)
    ) %>%
    rename_with(~ paste0("avg_", ., "_last10"))

opponent_average_team_full <- opponent_average_team %>%
    left_join(opponent_average_team_last10, by = c("avg_team_team" = "avg_team_team_last10"))

league_average <- team_data %>% #Statistics of the entire league, used for later comparisons
    summarize(
        league_pts = round(mean(team_pts, na.rm = TRUE), 2), 
        league_reb = round(mean(team_reb, na.rm = TRUE), 2),
        league_ast = round(mean(team_ast, na.rm = TRUE), 2),
        league_fgpct = round(mean(team_fgpct, na.rm = TRUE), 2),
        league_threefgpct = round(mean(team_threefgpct, na.rm = TRUE), 2),
        league_tspct = round(mean(team_tspct, na.rm = TRUE), 2), 
        league_offrating = round(mean(team_offrating, na.rm = TRUE), 2),
        league_defrating = round(mean(team_defrating, na.rm = TRUE), 2),
        league_netrating = round(mean(team_netrating, na.rm = TRUE), 2),
        league_tov = round(mean(team_tov, na.rm = TRUE), 2),
        league_plusminus = round(mean(team_plusminus, na.rm = TRUE), 2)
    ) %>%
    rename_with(~ paste0("avg_", .))

team_data <- team_data %>% #Joining summary statistic data frames to the main data frame
    left_join(average_team_full, by = c("team_team" = "avg_team_team")) %>%
    left_join(opponent_average_team_full, by = c("team_opponent" = "avg_team_team"))

team_data <- data.frame(team_data, league_average) #Adding league average statistics to the main data frame
```

## Data Cleaning 5: Adding Descriptive Variables

1.  Adding the conference each team plays in.
2.  Adding the division each team plays in.

```{r}
team_data <- team_data %>%
    mutate(team_conference = case_when(
        team_team == "bos" | team_team == "bkn" | team_team == "nyk" | team_team == "phi" | team_team == "tor" 
        | team_team == "chi" | team_team == "cle" | team_team == "det" | team_team == "ind" | team_team == "mil" 
        | team_team == "atl" | team_team == "cha" | team_team == "mia" | team_team == "orl" | team_team == "was" ~ "Eastern",
        team_team == "den" | team_team == "min" | team_team == "okc" | team_team == "por" | team_team == "uta" 
        | team_team == "gsw" | team_team == "lac" | team_team == "lal" | team_team == "phx" | team_team == "sac" 
        | team_team == "dal" | team_team == "hou" | team_team == "mem" | team_team == "nop" | team_team == "sas" ~ "Western"
    )) %>%
    mutate(team_division = case_when(
        team_team == "bos" | team_team == "bkn" | team_team == "nyk" | team_team == "phi" | team_team == "tor" ~ "Atlantic",
        team_team == "chi" | team_team == "cle" | team_team == "det" | team_team == "ind" | team_team == "mil" ~ "Central",
        team_team == "atl" | team_team == "cha" | team_team == "mia" | team_team == "orl" | team_team == "was" ~ "Southeast",
        team_team == "den" | team_team == "min" | team_team == "okc" | team_team == "por" | team_team == "uta" ~ "Northwest",
        team_team == "gsw" | team_team == "lac" | team_team == "lal" | team_team == "phx" | team_team == "sac" ~ "Pacific",
        team_team == "dal" | team_team == "hou" | team_team == "mem" | team_team == "nop" | team_team == "sas" ~ "Southwest"
    )) 
```

## Data Cleaning 6: Columns Sums and Rates (Overall and Cumulative)

1.  Needed Sums
    1.  Win
    2.  Loss
    3.  Games Played
    4.  Favored
    5.  Upset
    6.  Close Win
    7.  Not Favored
    8.  Creating Upset

```{r}
team_data <- team_data %>%
  group_by(team_team) %>%
  mutate(
    # General Sums
    team_wins_sum = sum(team_win, na.rm = TRUE),
    team_losses_sum = sum(team_loss, na.rm = TRUE),
    team_games_sum = team_wins_sum + team_losses_sum,
    
    team_favored_sum = sum(team_favored, na.rm = TRUE),
    team_upset_sum = sum(team_upset, na.rm = TRUE),
    
    team_close_win_sum = sum(team_close_win, na.rm = TRUE),
    
    team_not_favored_sum = sum(team_not_favored, na.rm = TRUE),
    team_create_upset_sum = sum(team_create_upset, na.rm = TRUE),
    
    # Cumulative Sums with NA handling
    team_wins_cumsum = cumsum(ifelse(is.na(team_win), 0, team_win)),
    team_losses_cumsum = cumsum(ifelse(is.na(team_loss), 0, team_loss)),
    team_games_cumsum = team_wins_cumsum + team_losses_cumsum,
    
    team_favored_cumsum = cumsum(ifelse(is.na(team_favored), 0, team_favored)),
    team_upset_cumsum = cumsum(ifelse(is.na(team_upset), 0, team_upset)),
    
    team_close_win_cumsum = cumsum(ifelse(is.na(team_close_win), 0, team_close_win)),
    
    team_not_favored_cumsum = cumsum(ifelse(is.na(team_not_favored), 0, team_not_favored)),
    team_create_upset_cumsum = cumsum(ifelse(is.na(team_create_upset), 0, team_create_upset)),
    
    # General Rates with NA/Zero handling
    team_win_gen_rate = ifelse(team_games_sum == 0, NA, round(team_wins_sum / team_games_sum, 3)),
    
    team_favored_gen_rate = ifelse(team_games_sum == 0, NA, round(team_favored_sum / team_games_sum, 3)),
    team_upset_gen_rate = ifelse(team_favored_sum == 0, NA, round(team_upset_sum / team_favored_sum, 3)),
    
    team_close_win_gen_rate = ifelse(team_games_sum == 0, NA, round(team_close_win_sum / team_games_sum, 3)),
    
    team_not_favored_gen_rate = ifelse(team_games_sum == 0, NA, round(team_not_favored_sum / team_games_sum, 3)),
    team_create_upset_gen_rate = ifelse(team_not_favored_sum == 0, NA, round(team_create_upset_sum / team_not_favored_sum, 3)),
    
    # Cumulative Rates with NA/Zero handling
    team_win_cumsum_rate = ifelse(team_games_cumsum == 0, NA, round(team_wins_cumsum / team_games_cumsum, 3)),
    
    team_favored_cumsum_rate = ifelse(team_games_cumsum == 0, NA, round(team_favored_cumsum / team_games_cumsum, 3)),
    team_upset_cumsum_rate = ifelse(team_favored_cumsum == 0, NA, round(team_upset_cumsum / team_favored_cumsum, 3)),
    
    team_close_win_cumsum_rate = ifelse(team_games_cumsum == 0, NA, round(team_close_win_cumsum / team_games_cumsum, 3)),
    
    team_not_favored_cumsum_rate = ifelse(team_games_cumsum == 0, NA, round(team_not_favored_cumsum / team_games_cumsum, 3)),
    team_create_upset_cumsum_rate = ifelse(team_not_favored_cumsum == 0, NA, round(team_create_upset_cumsum / team_not_favored_cumsum, 3))
  ) %>%
  ungroup()

```

------------------------------------------------------------------------

# Modeling & Data Cleaning

```{r}
team_data <- team_data %>%
    mutate(team_winloss = factor(team_winloss,
                                 levels = c(0, 1),
                                 labels = c("loss", "win")),
           team_close_win = factor(team_close_win,
                                   levels = c(0, 1),
                                   labels = c("blowout_win", "close_win")),
           team_upset = factor(team_upset,
                               levels = c(0, 1),
                               labels = c("no_upset", "upset")))
```


## Model Testing 1: Win Loss Model

1.  Model 1: General Model
    -   Home/Away
    -   Average Offensive Rating
    -   Average Defensive Rating
    -   Opponent Average Offensive Rating
    -   Opponent Average Defensive Rating
2.  Model 2: Weighted Offensive and Defensive Rating (Adding more weight to recent games)
    -   Home/Away
    -   Weighted Average Offensive Rating
    -   Weighted Average Defensive Rating
    -   Weighted Opponent Average Offensive Rating
    -   Weighted Opponent Average Defensive Rating

```{r}
#Win Loss Null Model
null_winloss_model <- glm(team_winloss ~ team_moneyline
                          , data = team_data, family = binomial)
summary_null_winloss_model <- summary(null_winloss_model)
summary_null_winloss_model

#Win Loss Model 1
winloss_model <- glm(team_winloss ~ team_home 
                     + avg_team_offrating 
                     + avg_team_defrating
                     + avg_opponent_team_offrating
                     + avg_opponent_team_defrating
                     ,data = team_data, family = binomial)
summary_winloss_model <- summary(winloss_model)
summary_winloss_model

winloss_model_v3 <- glm(team_winloss ~ team_home 
                     + avg_team_offrating 
                     + avg_team_defrating
                     + avg_opponent_team_offrating
                     + avg_opponent_team_defrating
                     + team_upset_cumsum_rate
                     ,data = team_data, family = binomial)
summary_winloss_model_v3 <- summary(winloss_model_v3)
summary_winloss_model_v3
```

### Model Data Creation 1: Win Loss Model

```{r}
#Win Loss 1 Data Frame
winloss_df <- as.data.frame(summary_winloss_model$coefficients) %>%
    rownames_to_column(var = "Variable") %>%
    as_tibble() %>%
    filter(`Pr(>|z|)` < .05)

#Win Loss 3 Data Frame
winloss_df_v3 <- as.data.frame(summary_winloss_model_v3$coefficients) %>%
    rownames_to_column(var = "Variable") %>%
    as_tibble() %>%
    filter(`Pr(>|z|)` < .05)
```

### Data Cleaning 7: Adding Win Loss Model (Estimates and Probability)

```{r}
#Used to exponentiate coefficients for probability
e <- exp(1)

team_data <- team_data %>%
    #Win Loss 1 Model
    mutate(winloss_team_prob = round(100 * (1 / (1 + e^-((winloss_df$Estimate[1] * team_home) 
                                               + (winloss_df$Estimate[2] * avg_team_offrating) 
                                               + (winloss_df$Estimate[3] * avg_team_defrating) 
                                               + (winloss_df$Estimate[4] * avg_opponent_team_offrating) 
                                               + (winloss_df$Estimate[5] * avg_opponent_team_defrating)))), 1)) %>%
    #Win Loss 3 Model
    mutate(winloss_v3_team_prob = round(100 * (1 / (1 + e^-((winloss_df_v3$Estimate[1] * team_home) 
                                               + (winloss_df_v3$Estimate[2] * avg_team_offrating) 
                                               + (winloss_df_v3$Estimate[3] * avg_team_defrating) 
                                               + (winloss_df_v3$Estimate[4] * avg_opponent_team_offrating) 
                                               + (winloss_df_v3$Estimate[5] * avg_opponent_team_defrating)
                                               + (winloss_df_v3$Estimate[6] * team_upset_cumsum_rate)))), 1))
```

## Model Testing 2: Upset Model

1.  Upset Model 1: General Model (w/ Overall Rate)
    -   Team Overall Upset Rate (All games to present date)
    -   Spread for the Game
2.  Upset Model 2: Cumulative Model
    -   Team Moving Upset Rate (All games to that specific observation)
    -   Spread for the Game

```{r}
#Upset Null Model
null_upset_model <- glm(team_upset ~ team_moneyline
                        , data = team_data, family = binomial)
summary_null_upset_model <- summary(null_upset_model)
summary_null_upset_model

#Upset Model 1
upset_model <- glm(team_upset ~ team_upset_gen_rate
                   + team_spread
                   , data = team_data, family = binomial)
summary_upset_model <- summary(upset_model)
summary_upset_model

#Upset Model 2
upset_model_v2 <- glm(team_upset ~ team_upset_cumsum_rate
                      + team_spread
                      , data = team_data, family = binomial)
summary_upset_v2_model <- summary(upset_model_v2)
summary_upset_v2_model
```

### Model Data Creation 2: Upset Model

```{r}
#Upset 1 Data Frame
upset_df <- as.data.frame(summary_upset_model$coefficients) %>%
    rownames_to_column(var = "Variable")%>%
    as_tibble() %>%
    filter(`Pr(>|z|)` < .05)
#Upset 2 Data Frame
upset_v2_df <- as.data.frame(summary_upset_v2_model$coefficients) %>%
    rownames_to_column(var = "Variable") %>%
    as_tibble() %>%
    filter(`Pr(>|z|)` < .05)
```

### Data Cleaning 9: Adding Upset Model

```{r}
team_data <- team_data %>%
    #Upset Model 1
    mutate(upset_team_prob = case_when(
        team_favored == 1 ~ round(100 * (1 / (1 + e^-(upset_df$Estimate[1] + 
            (upset_df$Estimate[2] * team_upset_gen_rate) + 
            (upset_df$Estimate[3] * team_spread)))), 1), 
        team_favored == 0 ~ NA
    )) %>%
    #Upset Model 2
    mutate(upset_v2_team_prob = case_when(
        team_favored == 1 ~ round(100 * (1 / (1 + e^-(upset_v2_df$Estimate[1] + 
            (upset_v2_df$Estimate[2] * team_upset_cumsum_rate) + 
            (upset_v2_df$Estimate[3] * team_spread)))), 1), 
        team_favored == 0 ~ NA
    ))
```

## Model Testing 3: Close and Blowout Wins

1.  Close Win Model 1: General Model
    -   Average Net Rating
    -   Opponent Average Net Rating
2.  Close Win Model 2:
    -   Weighted Average Net Rating
    -   Weighted Opponent Average Net Rating
3.  Close Win Model 3:
    -   Average Net Rating
    -   Opponent Average Net Rating
    -   Moving Close Win Rate (All games to that specific observation)

```{r}
#Close Win Null Model
null_close_win_model <- glm(team_close_win ~ team_line_winmargin1
                            , data = team_data, family = binomial)
summary_null_close_win_model <- summary(null_close_win_model)
summary_null_close_win_model

#Close Win Model 1
close_win_model <- glm(team_close_win ~ avg_team_netrating
                   + avg_opponent_team_netrating
                      , data = team_data, family = binomial)
summary_close_win_model <- summary(close_win_model)
summary_close_win_model

#Close Win Model 3
close_win_model_v3 <- glm(team_close_win ~ avg_team_netrating
                   + avg_opponent_team_netrating
                   + team_close_win_cumsum_rate
                      , data = team_data, family = binomial)
summary_close_win_model_v3 <- summary(close_win_model_v3)
summary_close_win_model_v3
```

### Model Data Creation 3: PlusMinus (Margin of Victory)

```{r}
#Close Win 1 Data Frame 
close_win_df <- as.data.frame(summary_close_win_model$coefficients) %>%
    rownames_to_column(var = "Variable") %>%
    as_tibble() %>%
    filter(`Pr(>|z|)` < .05)

#Close Win 3 Data Frame
close_win_df_v3 <- as.data.frame(summary_close_win_model_v3$coefficients) %>%
    rownames_to_column(var = "Variable") %>%
    as_tibble() %>%
    filter(`Pr(>|z|)` < .05)
```

### Data Cleaning 10:

```{r}
team_data <- team_data %>%
    #Close Win Model 1
    mutate(close_win_prob = round(100 * (1 / (1 + e^-((close_win_df$Estimate[1])
           + (close_win_df$Estimate[2] * avg_team_netrating)
           + (close_win_df$Estimate[3] * avg_opponent_team_netrating)))), 1)) %>%
    
    #Close Win Model 3
    mutate(close_win_v3_prob = round(100 * (1 / (1 + e^-((close_win_df_v3$Estimate[1])
           + (close_win_df_v3$Estimate[2] * avg_team_netrating)
           + (close_win_df_v3$Estimate[3] * avg_opponent_team_netrating)
           + (close_win_df_v3$Estimate[4] * team_close_win_cumsum_rate)))), 1))
```

# Data Visualizations

```{r}
change_over_time <- ggplot(team_data, aes(x = team_date, y = team_offrating, color = as.factor(team_winloss))) +
    geom_point() +
    geom_path() +
#    geom_hline(aes(yintercept = avg_team_offrating), linetype = "solid", color = "blue") +
    geom_hline(aes(yintercept = avg_league_offrating), linetype = "solid", color = "black") +
    facet_wrap(~team_team)
change_over_time
#ggsave(plot = change_over_time, "/Users/camsmithers/Desktop/NBA Project/Main/Visualizations/team_offrating.png", width = 50, height = 30, units = "cm")
change_over_time_2 <- ggplot(team_data, aes(x = team_date, y = team_defrating, color = as.factor(team_winloss))) +
    geom_point() +
    geom_path() + 
#    geom_hline(aes(yintercept = avg_team_defrating), linetype = "solid", color = "blue") +
    geom_hline(aes(yintercept = avg_league_defrating), linetype = "solid", color = "black") +
    facet_wrap(~team_team)
change_over_time_2
#ggsave(plot = change_over_time_2, "/Users/camsmithers/Desktop/NBA Project/Main/Visualizations/team_defrating.png", width = 50, height = 30, units = "cm")

scatter_1 <- ggplot(team_data, aes(x = team_tspct, team_offrating)) + 
    geom_point() +
    geom_vline(aes(xintercept = avg_league_tspct), color = "red", linewidth = 1, linetype = "solid") +
    geom_smooth(method = "lm", se = TRUE, color = "blue")
scatter_1
```

```{r warning=FALSE}
a <- ggplot(team_data, aes(team_team, team_offrating, fill = as.factor(team_team)))
b <- ggplot(team_data, aes(team_team, team_defrating, fill = as.factor(team_team)))

a + geom_boxplot()
b + geom_boxplot()

team_data_long <- team_data %>%
  gather(key = "rating_type", value = "rating_value", team_offrating, team_defrating)

# Create the combined plot
combined_plot <- ggplot(team_data_long, aes(team_team, rating_value, fill = as.factor(team_team))) +
  geom_boxplot() +
  facet_wrap(~ rating_type, scales = "free_y") +  # Facet by rating type
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +  # Rotate x-axis labels for better readability
  labs(title = "Team Offense and Defense Ratings",
       x = "Team",
       y = "Rating")

# Display the plot
combined_plot
```
