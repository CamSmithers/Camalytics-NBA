---
title: "NBA Regression Analysis"
author: "Cam Smithers"
output: 
  html_notebook: 
    theme: paper
---

# Camalytics

## Loading Packages

```{r}
library(dplyr)
library(ggplot2)
library(tidyverse)
library(foreign)
library(nnet)
library(readr)
```

## Loading in All Data

```{r warning=FALSE}
#Running script that contains all data (teams and players)
source("/Users/camsmithers/Desktop/NBA Project/Main/Data/DataScript.R")

#Joining all team data into one data frame
all_team_data <- team_traditional %>%
    left_join(team_advanced, by = c("team", 'date')) %>% 
    left_join(team_misc, by = c("team", "date")) %>%
    left_join(team_scoring, by = c("team", "date")) %>%
    left_join(team_outcome, by = c("team", "date"))
```

## Data Cleaning 1: General Cleaning

```{r}
all_team_data <- all_team_data %>%
    dplyr::select(-opponent, -opponent.y, -opponent.x.x, -opponent.y.y, -home, -home.y, -home.x.x,
           -home.y.y, -blk.y, -pf.y) %>% #Removing duplicated columns
    rename("opponent" = "opponent.x", "blk" = "blk.x", "pf" = "pf.x", "home" = "home.x") %>% #Wanted to keep specific duplicated to be used as the main
    dplyr::select(team, home, everything()) #Re-ordering variables for better visualization
team_temporary_df <- all_team_data %>% #Temporary data frame used add opponents' points scored
    dplyr::select(team, opponent, date, pts) %>%
    rename("team_1" = "team", "team_2" = "opponent")

all_team_data <- all_team_data %>% #Joining opponent points to original data frame
    left_join(team_temporary_df, by = c("team" = "team_2", "date")) %>%
    rename("opponent_pts" = "pts.y", "pts" = "pts.x") %>%
    dplyr::select(-team_1)

all_team_data <- all_team_data %>% #Re-ordering for better visualization
    dplyr::select(date, home, team, pts, opponent, opponent_pts, everything()) %>%
    rename_with(~ paste0("team_", .)) #Adding _team to each observation for easier recognition of variable for later cleaning, model building, and joins
```

## Data Cleaning 2: Creating Variables for Outcomes

1.  Primary Outcome: Game Outcome Type
2.  Changing Variable to Factor
3.  Creating Binary Variables for Primary Outcomes
4.  Secondary Outcome: Game Outcome without Magnitude

```{r}
all_team_data <- all_team_data %>%
    #Primary Outcome: Types of Outcome
    mutate(team_game_outcome = case_when(
        team_plusminus < 0 ~ 1,
        team_plusminus <= 10 & team_plusminus > 0 ~ 2,
        team_plusminus > 10 ~ 3
    )) %>%
    #Primary Outcome as Binary
    mutate(team_loss = ifelse(team_game_outcome == 1, 1, 0),
           team_close_win = ifelse(team_game_outcome == 2, 1, 0),
           team_blowout_win = ifelse(team_game_outcome == 3, 1, 0)) %>%
    #Secondary Outcome 1: Sub-Type of Outcome
    mutate(team_win = ifelse(team_game_outcome == 2 | team_game_outcome == 3, 1, 0)) %>%
    #
    mutate(team_game_outcome = factor(team_game_outcome,
                                      levels = c(1, 2, 3),
                                      labels = c("loss", "close_win", "blowout_win")))
    
```

## Data Cleaning 3: Team Averages

```{r}
all_team_average <- all_team_data %>%
    group_by(team_team) %>%
    summarize(
        #Major Statistical Categories
        team_avg_pts = round(mean(team_pts, na.rm = TRUE), 1),
        team_avg_pts_allowed = round(mean(team_opponent_pts, na.rm = TRUE), 1),
        team_avg_reb = round(mean(team_reb, na.rm = TRUE), 1),
        team_avg_ast = round(mean(team_ast, na.rm = TRUE), 1),
        team_avg_tov = round(mean(team_tov, na.rm = TRUE), 1),
        #Advanced Metrics
        team_avg_offrating = round(mean(team_offrating, na.rm = TRUE), 1),
        team_avg_defrating = round(mean(team_defrating, na.rm = TRUE), 1),
        team_avg_netrating = round(mean(team_netrating, na.rm = TRUE), 1),
        team_avg_rebpct = round(mean(team_rebpct, na.rm = TRUE), 1),
        team_avg_astpct = round(mean(team_astpct, na.rm = TRUE), 1)
    )

all_team_average_2 <- all_team_data %>%
    group_by(team_team) %>%
    mutate(team_cummean_offrating = round(cummean(team_offrating), 1),
           team_cummean_defrating = round(cummean(team_defrating), 1)) %>%
    ungroup() %>%
    select(team_team, team_date, team_cummean_offrating, team_cummean_defrating)

all_opponent_average <- all_team_data %>%
    group_by(team_team) %>%
    summarize(
        #Major Statistical Categories
        opponent_avg_pts = round(mean(team_pts, na.rm = TRUE), 1),
        opponent_avg_pts_allowed = round(mean(team_opponent_pts, na.rm = TRUE), 1),
        opponent_avg_reb = round(mean(team_reb, na.rm = TRUE), 1),
        opponent_avg_ast = round(mean(team_ast, na.rm = TRUE), 1),
        opponent_avg_tov = round(mean(team_tov, na.rm = TRUE), 1),
        #Advanced Metrics
        opponent_avg_offrating = round(mean(team_offrating, na.rm = TRUE), 1),
        opponent_avg_defrating = round(mean(team_defrating, na.rm = TRUE), 1),
        opponent_avg_netrating = round(mean(team_netrating, na.rm = TRUE), 1),
        opponent_avg_rebpct = round(mean(team_rebpct, na.rm = TRUE), 1),
        opponent_avg_astpct = round(mean(team_astpct, na.rm = TRUE), 1)
    )

all_opponent_average_2 <- all_team_data %>%
    group_by(team_team) %>%
    mutate(opponent_cummean_offrating = round(cummean(team_offrating), 1),
           opponent_cummean_defrating = round(cummean(team_defrating), 1)) %>%
    ungroup() %>%
    select(team_team, team_date, opponent_cummean_offrating, opponent_cummean_defrating)

all_league_average <- all_team_data %>%
    summarize(
        #Major Statistical Categories
        league_avg_pts = round(mean(team_pts, na.rm = TRUE), 1),
        league_avg_pts_allowed = round(mean(team_opponent_pts, na.rm = TRUE), 1),
        league_avg_reb = round(mean(team_reb, na.rm = TRUE), 1),
        league_avg_ast = round(mean(team_ast, na.rm = TRUE), 1),
        league_avg_tov = round(mean(team_tov, na.rm = TRUE), 1),
        #Advanced Metrics
        league_avg_offrating = round(mean(team_offrating, na.rm = TRUE), 1),
        league_avg_defrating = round(mean(team_defrating, na.rm = TRUE), 1),
        league_avg_netrating = round(mean(team_netrating, na.rm = TRUE), 1),
        league_avg_rebpct = round(mean(team_rebpct, na.rm = TRUE), 1),
        league_avg_astpct = round(mean(team_astpct, na.rm = TRUE), 1)
    )

all_team_data <- all_team_data %>%
    left_join(all_team_average, by = c("team_team" = "team_team")) %>%
    left_join(all_opponent_average, by = c("team_opponent" = "team_team")) %>%
    left_join(all_team_average_2, by = c("team_team", "team_date")) %>%
    left_join(all_opponent_average_2, by = c("team_opponent" = "team_team", "team_date"))

all_team_data <- data.frame(all_team_data, all_league_average)
```

## Data Cleaning 4: Metrics for Measurement

```{r}
all_team_data <- all_team_data %>%
    #Statistics Above League Average
    mutate(pts_bt_league = ifelse(team_avg_pts > league_avg_pts, 1, 0),
           pts_allowed_bt_league = ifelse(team_avg_pts < league_avg_pts_allowed, 1, 0),
           reb_bt_league = ifelse(team_avg_reb > league_avg_reb, 1, 0),
           ast_bt_league = ifelse(team_avg_ast > league_avg_ast, 1, 0),
           tov_bt_league = ifelse(team_avg_tov < league_avg_tov, 1, 0),
           offrating_bt_league = ifelse(team_avg_offrating > league_avg_offrating, 1, 0),
           defrating_bt_league = ifelse(team_avg_defrating < league_avg_defrating, 1, 0),
           netrating_bt_league = ifelse(team_avg_netrating > league_avg_netrating, 1, 0),
           rebpct_bt_league = ifelse(team_avg_rebpct > league_avg_rebpct, 1, 0),
           astpct_bt_league = ifelse(team_avg_astpct > league_avg_astpct, 1, 0)) %>%
    #Count of Statistics Above League Average
    mutate(stats_bt_league = pts_bt_league + pts_allowed_bt_league + reb_bt_league + tov_bt_league + 
               offrating_bt_league + defrating_bt_league + netrating_bt_league + 
               rebpct_bt_league + astpct_bt_league)
```

# Model Building

```{r}
options(scipen = 999)

#Overall Average Model

overall_avg <- multinom(team_game_outcome ~ team_avg_offrating
                 + team_avg_defrating
                 + opponent_avg_offrating
                 + opponent_avg_defrating, data = all_team_data)
overall_avg_summary <- summary(overall_avg)
overall_avg_summary

overall_avg_z_values <- overall_avg_summary$coefficients / overall_avg_summary$standard.errors
overall_avg_p_values <- (1 - pnorm(abs(overall_avg_z_values), 0, 1)) * 2
overall_avg_p_values

overall_avg_exp_coefs <- exp(coef(overall_avg_summary))
overall_avg_exp_coefs

#Cumulative Average Model

cumulative_avg <- multinom(team_game_outcome ~ team_cummean_offrating
                           + team_cummean_defrating
                           + opponent_cummean_offrating
                           + opponent_cummean_defrating, data = all_team_data)
cumulative_avg_summary <- summary(cumulative_avg)
cumulative_avg_summary

cumulative_avg_z_values <- cumulative_avg_summary$coefficients / cumulative_avg_summary$standard.errors
cumulative_avg_p_values <- (1 - pnorm(abs(cumulative_avg_z_values), 0, 1)) * 2
cumulative_avg_p_values

cumulative_avg_exp_coefs <- exp(coef(cumulative_avg_summary))
cumulative_avg_exp_coefs
```

## Model Predictions

### Overall Average Model

```{r}
#Daily Data Set
new_all_team_data <- all_team_data %>%
    filter(team_date == Sys.Date())

#Overall Average Model
overall_avg_predictions <- fitted(overall_avg_summary)
overall_avg_predicted_values <- predict(overall_avg, newdata = new_all_team_data, type = "probs")
overall_avg_daily_data <- cbind(new_all_team_data, overall_avg_predicted_values)
```

### Cumulative Average Model

```{r eval=FALSE, eval=FALSE}
#Daily Data Set
new_all_team_data_2 <- all_team_data %>%
    filter(team_date == Sys.Date())

#Cumulative Average Model
cumulative_avg_predictions <- fitted(cumulative_avg_summary)
cumulative_avg_predicted_values <- predict(cumulative_avg, newdata = new_all_team_data_2, type = "probs")
cumulative_avg_daily_data <- cbind(new_all_team_data_2, cumulative_avg_predicted_values)
```

## Data Cleaning 5: Predictions in Data Frame

### Overall Average Model

```{r}
#Overall Average
temporary_df_2 <- overall_avg_daily_data %>%
    dplyr::select(team_team, team_date, loss) %>%
    rename("opponent_loss" = "loss", "team_dummy" = "team_team")

overall_avg_daily_data <- overall_avg_daily_data %>%
    left_join(temporary_df_2, by = c("team_opponent" = "team_dummy", "team_date"))

overall_avg_daily_data <- overall_avg_daily_data %>%
    mutate(projected_outcome = ifelse(loss < opponent_loss, 1, 0)) %>%
    mutate(projected_outcome_type = case_when(
        projected_outcome == 1 ~ ifelse(close_win > blowout_win, "Close Win", "Blowout Win"),
        TRUE ~ "Loss"
    ))

overall_avg_daily_data <- overall_avg_daily_data %>%
    dplyr::select(team_team, team_opponent, team_date, projected_outcome, projected_outcome_type)
View(overall_avg_daily_data)
```

### Cumulative Average Model

```{r eval=FALSE, include=FALSE}
#Cumulative Average
temporary_df_3 <- cumulative_avg_daily_data %>%
    dplyr::select(team_team, team_date, loss) %>%
    rename("opponent_loss" = "loss", "team_dummy" = "team_team")

cumulative_avg_daily_data <- cumulative_avg_daily_data %>%
    left_join(temporary_df_2, by = c("team_opponent" = "team_dummy", "team_date"))

cumulative_avg_daily_data <- cumulative_avg_daily_data %>%
    mutate(projected_outcome = ifelse(loss < opponent_loss, 1, 0)) %>%
    mutate(projected_outcome_type = case_when(
        projected_outcome == 1 ~ ifelse(close_win > blowout_win, "Close Win", "Blowout Win"),
        TRUE ~ "Loss"
    ))

cumulative_avg_daily_data <- cumulative_avg_daily_data %>%
    dplyr::select(team_team, team_opponent, team_date, projected_outcome, projected_outcome_type)
View(cumulative_avg_daily_data)
```